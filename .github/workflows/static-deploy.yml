name: CorridorOS Pages Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: dist
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Smoke check (optional)
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
          CUSTOM_DOMAIN: ${{ secrets.CUSTOM_DOMAIN }}
        shell: bash
        run: |
          set -euo pipefail
          sleep ${PAGES_WAIT:-15}
          echo "ðŸ”Ž Base URL: $BASE_URL"
          BUST=$RANDOM
          curl -sS --retry 5 --retry-delay 2 --retry-all-errors -H "Cache-Control: no-cache" \
            "${BASE_URL}?v=${BUST}" | grep -q 'Reserve Light. Guarantee Memory.' || { echo "index.html content check failed"; exit 1; }
          curl -sS -I --retry 5 --retry-delay 2 --retry-all-errors -H "Cache-Control: no-cache" \
            "${BASE_URL}corridor-os.html?v=${BUST}" | grep -Eq 'HTTP/.+ 200' || { echo "corridor-os.html not 200"; exit 1; }
          if ! curl -sS -I --retry 5 --retry-delay 2 --retry-all-errors -H "Cache-Control: no-cache" \
            "${BASE_URL}demo/corridoros-demo.mp4?v=${BUST}" | grep -Eq 'HTTP/.+ 200'; then
            echo "(info) demo video not reachable yet; continuing"
          fi
          if [ -n "${CUSTOM_DOMAIN:-}" ]; then
            echo "â†’ Checking https://${CUSTOM_DOMAIN}/ (optional)"
            curl -sS --retry 5 --retry-delay 3 --retry-all-errors -H "Cache-Control: no-cache" \
              "https://${CUSTOM_DOMAIN}/?v=${BUST}" | grep -q 'Reserve Light. Guarantee Memory.' || echo "(info) custom domain not ready yet"
          fi
          echo "âœ… Smoke checks passed"
