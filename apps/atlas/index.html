<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Corridor Atlas — Offline Preview</title>
  <style>
    :root{--c:#00c8ff;--t:#00ffd5;--bg:#0b1020;--text:#e6fdff}
    html,body{height:100%;margin:0;background:radial-gradient(120% 120% at 50% 0%, #13283f 0%, #0e1a2b 48%, #0b1020 100%);color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .bar{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800}
    .title img{height:22px;border-radius:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
    .card{background:linear-gradient(180deg, rgba(0,200,255,.10), rgba(0,255,213,.08));border:1px solid rgba(0,200,255,.22);border-radius:12px;padding:12px}
    .gallery{display:grid;grid-template-columns:1fr;gap:10px}
    .gallery img{width:100%;height:180px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.14)}
    .btn{border:1px solid rgba(0,200,255,.4);background:transparent;border-radius:10px;padding:8px 12px;color:var(--text);cursor:pointer}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,200,255,.3);margin:0 6px 6px 0;font-size:12px}
    .imgs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .imgs img{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.14)}
    .map{position:relative;width:100%;height:240px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg,#0b1426,#09101f)}
    .map canvas{position:absolute;inset:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="title"><img src="../vytall/assets/vytall_logo.png" alt="icon"/> Corridor Atlas — Offline Preview</div>
      <div>
        <button class="btn" onclick="window.top?.postMessage({type:'atlas-open-repo'},'*')">Open Repo</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Trips</h3>
      <form id="tripForm" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;align-items:end">
        <label style="display:grid;gap:4px">Destination<input required name="dest" placeholder="City / Site" class="btn" style="padding:8px"></label>
        <label style="display:grid;gap:4px">Start<input required type="date" name="start" class="btn" style="padding:8px"></label>
        <label style="display:grid;gap:4px">End<input required type="date" name="end" class="btn" style="padding:8px"></label>
        <label style="display:grid;gap:4px">Hotel<input name="hotel" placeholder="Hotel name" class="btn" style="padding:8px"></label>
        <label style="display:grid;gap:4px">Guests<input name="guests" type="number" min="1" value="2" class="btn" style="padding:8px"></label>
        <button class="btn" style="height:36px" type="submit">Add Trip</button>
      </form>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="exportTrips">Export JSON</button>
        <label class="btn" for="importTrips" style="cursor:pointer">Import JSON<input type="file" id="importTrips" accept="application/json" style="display:none"></label>
      </div>
      <div id="tripList" style="margin-top:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
    </div>

    <div id="dyn" style="margin-top:12px"></div>

    <!-- Booking overlay -->
    <div id="booking" style="position:fixed;inset:0;backdrop-filter:blur(8px);background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10">
      <div style="width:min(720px,92vw);background:linear-gradient(180deg, rgba(0,200,255,.12), rgba(0,255,213,.08));border:1px solid rgba(0,200,255,.25);border-radius:12px;padding:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><strong>Booking</strong><button class="btn" onclick="closeBooking()">✕</button></div>
        <div id="bookingSteps"></div>
      </div>
    </div>

    <!-- Photo picker overlay -->
    <div id="photoPicker" style="position:fixed;inset:0;backdrop-filter:blur(8px);background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:11">
      <div style="width:min(920px,94vw);max-height:86vh;overflow:auto;background:linear-gradient(180deg, rgba(0,200,255,.12), rgba(0,255,213,.08));border:1px solid rgba(0,200,255,.25);border-radius:12px;padding:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><strong>Select Photo</strong><button class="btn" onclick="closePhotoPicker()">✕</button></div>
        <div id="photoGrid" class="imgs"></div>
      </div>
    </div>
  </div>
  <script>
    let ATLAS_MANIFEST=null;
    async function load(){
      const root = document.getElementById('dyn');
      try{
        const res = await fetch('assets/atlas_manifest.json', {cache:'no-cache'});
        const j = await res.json(); ATLAS_MANIFEST=j;
        const byCat = {};
        for(const it of j.items){ (byCat[it.category] ||= []).push(it); }
        const cats = Object.keys(byCat);
        const frag = document.createDocumentFragment();
        // quick nav
        const nav = document.createElement('div');
        nav.style.margin = '10px 0';
        cats.forEach(c=>{ const a=document.createElement('a'); a.href='#'+c; a.className='pill'; a.textContent=c; nav.appendChild(a); });
        frag.appendChild(nav);
        // sections
        const grid=document.createElement('div'); grid.className='grid';
        cats.forEach(c=>{
          const card=document.createElement('div'); card.className='card'; card.id=c;
          const h=document.createElement('h3'); h.textContent=c; h.style.margin='0 0 8px 0'; card.appendChild(h);
          const imgs=document.createElement('div'); imgs.className='imgs';
          byCat[c].forEach(it=>{ const img=document.createElement('img'); img.loading='lazy'; img.src=it.file; img.alt=it.name; imgs.appendChild(img); });
          card.appendChild(imgs); grid.appendChild(card);
        });
        frag.appendChild(grid);
        root.replaceChildren(frag);
      }catch(e){
        root.textContent='Failed to load gallery manifest.';
      }
    }
    load();

    // Trips logic (localStorage)
    const K='atlas-trips-v1';
    function readTrips(){ try{return JSON.parse(localStorage.getItem(K)||'[]')}catch(_){return []} }
    function writeTrips(t){ localStorage.setItem(K, JSON.stringify(t)); }
    function renderTrips(){
      const box=document.getElementById('tripList');
      const trips=readTrips();
      if(trips.length===0){ box.innerHTML='<div style="grid-column:1/-1;opacity:.8">No trips yet. Add one above.</div>'; return; }
      box.innerHTML='';
      for(const [i,t] of trips.entries()){
        const card=document.createElement('div');
        card.className='card';
        const img=t.photo?`<img src="${t.photo}" alt="photo" style="width:100%;height:120px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.14);margin-bottom:6px"/>`:'';
        card.innerHTML=`${img}<div style="font-weight:700">${t.dest}</div>
          <div style="opacity:.9">${t.start} → ${t.end}</div>
          <div style="opacity:.9">Hotel: ${t.hotel||'—'} · Guests: ${t.guests||2}</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class='btn' onclick='openBooking(${i})'>Book</button>
            <button class='btn' onclick='openPhotoPicker(${i})'>Photo</button>
            <button class='btn' onclick='delTrip(${i})'>Delete</button>
          </div>`;
        box.appendChild(card);
      }
    }
    document.getElementById('tripForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const trip={dest:fd.get('dest'), start:fd.get('start'), end:fd.get('end'), hotel:fd.get('hotel'), guests:parseInt(fd.get('guests')||'2',10)};
      const trips=readTrips(); trips.push(trip); writeTrips(trips); e.target.reset(); renderTrips();
      try{ window.top?.postMessage({type:'atlas-trip-added', trip},'*'); }catch(_){ }
    });
    function delTrip(i){ const trips=readTrips(); trips.splice(i,1); writeTrips(trips); renderTrips(); }
    window.addEventListener('load', renderTrips);

    // Booking flow (stepper)
    function openBooking(i){ const trips=readTrips(); const t=trips[i]; if(!t) return; const m=document.getElementById('booking'); m.style.display='flex';
      const steps=document.getElementById('bookingSteps');
      steps.innerHTML=`<div id='s1'>
        <div style='display:grid;grid-template-columns:repeat(3,1fr);gap:10px'>
          <label>Room Type<select id='room' class='btn'><option>Standard</option><option>Sea View</option><option>Suite</option></select></label>
          <label>Nights<input id='nights' class='btn' type='number' min='1' value='${Math.max(1, Math.ceil((new Date(t.end)-new Date(t.start))/86400000))}'/></label>
          <label>Guests<input id='gu' class='btn' type='number' min='1' value='${t.guests||2}'/></label>
        </div>
        <div style='margin-top:10px'>
          <div class='map'><canvas id='atlMap'></canvas></div>
          <div style='display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px'>
            <label>Lat<input id='lat' class='btn' placeholder='e.g., 27.2' value='${t.lat??""}'/></label>
            <label>Lon<input id='lon' class='btn' placeholder='e.g., 33.8' value='${t.lon??""}'/></label>
            <button class='btn' onclick='updateMapInputs()' type='button'>Update Map</button>
          </div>
        </div>
        <div style='margin-top:10px;display:flex;gap:8px'>
          <button class='btn' onclick='nextPay(${i})'>Next</button>
        </div>
      </div>`;
      setupMap(t.lat, t.lon);
    }
    function nextPay(i){ const steps=document.getElementById('bookingSteps');
      steps.innerHTML=`<div id='s2'>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px'>
          <label>Card Number<input id='cc' class='btn' placeholder='4242 4242 4242 4242'/></label>
          <label>Expiry<input id='exp' class='btn' placeholder='MM/YY'/></label>
          <label>CVC<input id='cvc' class='btn' placeholder='123'/></label>
          <label>Name<input id='name' class='btn' placeholder='Cardholder'/></label>
        </div>
        <div style='margin-top:10px;display:flex;gap:8px'>
          <button class='btn' onclick='confirmPay(${i})'>Confirm</button>
          <button class='btn' onclick='closeBooking()'>Cancel</button>
        </div>
      </div>`;
    }
    function confirmPay(i){ const trips=readTrips(); const t=trips[i]; const id='ATL-'+Math.random().toString(36).slice(2,8).toUpperCase();
      const steps=document.getElementById('bookingSteps');
      steps.innerHTML=`<div id='s3'>
        <div class='card' style='margin-bottom:8px'>
          <div style='font-weight:700;margin-bottom:4px'>Receipt</div>
          <div>Trip: ${t.dest} (${t.start} → ${t.end})</div>
          <div>Hotel: ${t.hotel||'—'} · Guests: ${t.guests||2}</div>
          <div>Location: ${ (t.lat??'—') }, ${ (t.lon??'—') }</div>
          <div>ID: <strong>${id}</strong></div>
        </div>
        <div style='display:flex;gap:8px'>
          <button class='btn' onclick='closeBooking()'>Close</button>
        </div>
      </div>`;
      try{ window.top?.postMessage({type:'atlas-booked', id, trip:t},'*'); }catch(_){ }
    }
    function closeBooking(){ document.getElementById('booking').style.display='none'; }

    // Map rendering (offline)
    function setupMap(lat,lon){ const c=document.getElementById('atlMap'); const ctx=c.getContext('2d'); const dpr=Math.min(2,window.devicePixelRatio||1); function draw(lati,loni){ const w=c.clientWidth, h=c.clientHeight; c.width=w*dpr; c.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h); // grid
        ctx.strokeStyle='rgba(255,255,255,.08)'; for(let x=0;x<w;x+=24){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); } for(let y=0;y<h;y+=24){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
        // simplistic coast blobs
        ctx.fillStyle='rgba(0,200,255,.10)'; ctx.beginPath(); ctx.ellipse(w*0.65,h*0.45,80,50,0,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(w*0.35,h*0.55,60,40,0,0,Math.PI*2); ctx.fill();
        // marker
        if(lati!=null && loni!=null && !isNaN(lati) && !isNaN(loni)){
          const x=(parseFloat(loni)+180)/360*w; const y=(90-parseFloat(lati))/180*h; ctx.fillStyle='#00ffd5'; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(0,200,255,.6)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.stroke(); }
      }
      new ResizeObserver(()=>{ draw(lat,lon); }).observe(c); draw(lat,lon); window.__drawMap=(a,b)=>draw(a,b); }
    function updateMapInputs(){ const lat=parseFloat(document.getElementById('lat').value); const lon=parseFloat(document.getElementById('lon').value); if(window.__drawMap) window.__drawMap(lat,lon); // persist to trip
      const trips=readTrips(); const idx=[...document.querySelectorAll('#tripList .card')].length?null:null; /* no-op */ }

    // Export/Import
    document.getElementById('exportTrips').addEventListener('click',()=>{ const data=JSON.stringify(readTrips(),null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='atlas-trips.json'; a.click(); URL.revokeObjectURL(a.href); });
    document.getElementById('importTrips').addEventListener('change',async (e)=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ localStorage.setItem(K, JSON.stringify(arr)); renderTrips(); } }catch(_){} e.target.value=''; });

    // Photo picker attach
    let __photoTripIndex=null;
    function openPhotoPicker(i){ __photoTripIndex=i; const m=document.getElementById('photoPicker'); m.style.display='flex'; renderPhotoGrid(); }
    function closePhotoPicker(){ document.getElementById('photoPicker').style.display='none'; __photoTripIndex=null; }
    function renderPhotoGrid(){ const grid=document.getElementById('photoGrid'); grid.innerHTML=''; const items=(ATLAS_MANIFEST?.items)||[]; items.forEach(it=>{ const im=document.createElement('img'); im.src=it.file; im.alt=it.name; im.style.cursor='pointer'; im.addEventListener('click',()=>{ if(__photoTripIndex!=null){ const trips=readTrips(); const t=trips[__photoTripIndex]; if(t){ t.photo=it.file; writeTrips(trips); renderTrips(); closePhotoPicker(); } } }); grid.appendChild(im); }); }
  </script>
</body>
</html>
